<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>moeday's blog</title>
    <link rel="stylesheet" href="./styles/index.css">
</head>

<body>
    <div class="navbar">
        <div class="navMenu" id="navMenu">
            moeday
        </div>
        <div class="navLinkGroup">
            <a class="navLink" href="./">Home</a>
            <a class="navLink" href="./tags.html">Tag</a>
            <a class="navLink" href="#">About</a>
        </div>
    </div>
    <div class="slogan">
        <img src="./pics/comic_0030.png" alt="空无一人的世界" style="width: 250px;">
    </div>
    <div class="content"></div>
</body>

<script>
    let cardTemplate = `
    <div class="card">
        <div class="title">
            <a href=""></a>
        </div>
        <div class="summary">
            <a href=""></a>
        </div>
        <div class="info">
            <div class="tag">
                <a href="#"></a>
            </div>
            <div class="countAndDate">
                <div class="count"></div>
                <div class="date"></div>
            </div>
        </div>
    </div>
    `;

    fetch("links.json")
        .then((response) => response.json())
        .then((urls) => {
            document.getElementsByClassName("content")[0].innerHTML = cardTemplate.repeat(urls.length);
            for (i = 0; i < urls.length; i++) {
                let p = i;
                fetch("posts/"+urls[i])
                    .then((response) => response.text())
                    .then((data) => {
                        const { metadata, text } = metadataParser(data);
                        const pureText = marked.parse(text).replace(/<[^>]*>/g, '');
                        document.getElementsByClassName("title")[p].querySelector("a").textContent = metadata.title;
                        document.getElementsByClassName("title")[p].querySelector("a").href = "/posts/" + "?title=" + urls[p];
                        document.getElementsByClassName("summary")[p].querySelector("a").textContent = metadata.url;
                        document.getElementsByClassName("summary")[p].querySelector("a").href = "/posts/" + "?title=" + urls[p];
                        document.getElementsByClassName("tag")[p].querySelector("a").textContent = metadata.categories;
                        document.getElementsByClassName("tag")[p].querySelector("a").href = "./tags.html#"+metadata.categories;
                        document.getElementsByClassName("date")[p].textContent = metadata.date;
                        document.getElementsByClassName("summary")[p].querySelector("a").textContent = pureText.substring(0, 80).concat(' ...');
                        document.getElementsByClassName("count")[p].textContent = pureText.length + "字"
                    });
            }
        })

    function metadataParser(text) {
        const regex = /^---\n([\s\S]*?)\n---\n/;
        const match = regex.exec(text);
        if (match) {
            const metadata = {};
            const lines = match[1].split('\n');
            for (const line of lines) {
                const [key, value] = line.split(':');
                metadata[key.trim()] = value.trim();
            }
            return {
                metadata: metadata,
                text: text.slice(match[0].length),
            };
        }
        return {
            text: text,
        };
    };

</script>
<script>
    //navbar
    document.querySelector("#navMenu").addEventListener("click", () => {
        document.getElementsByClassName('navLinkGroup')[0].classList.toggle("active");
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</html>