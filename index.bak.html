<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>moeday's blog</title>
    <link rel="stylesheet" href="./styles/index.css">
</head>

<body>
    <div class="navbar">
        <div class="navMenu" id="navMenu">
            moeday
        </div>
        <div class="navLinkGroup">
            <a class="navLink" href="./">Home</a>
            <a class="navLink" href="#">Tag</a>
            <a class="navLink" href="#">About</a>
        </div>
    </div>
    <div class="slogan">
        <img src="./pics/comic_0030.png" alt="空无一人的世界" style="width: 250px;">
    </div>
    <div class="content"></div>
</body>

<script>
    let cardTemplate = `
    <div class="card">
        <div class="title">
            <a href=""></a>
        </div>
        <div class="summary">
            <a href=""></a>
        </div>
        <div class="info">
            <div class="tag">
                <a href="#"></a>
            </div>
            <div class="countAndDate">
                <div class="count"></div>
                <div class="date"></div>
            </div>
        </div>
    </div>
    `;

    fetch("index.json")
        .then((response) => response.json())
        .then((data) => {
            document.getElementsByClassName("content")[0].innerHTML = cardTemplate.repeat(data.length);
            for (i in data) {
                document.getElementsByClassName("title")[i].querySelector("a").textContent = data[i].title;
                document.getElementsByClassName("title")[i].querySelector("a").href = "/posts/" + "?title=" + data[i].url;
                document.getElementsByClassName("summary")[i].querySelector("a").textContent = data[i].url;
                document.getElementsByClassName("summary")[i].querySelector("a").href = "/posts/" + "?title=" + data[i].url;
                document.getElementsByClassName("tag")[i].querySelector("a").textContent = data[i].tag;
                document.getElementsByClassName("date")[i].textContent = data[i].date;
            }
            let tempUrls = [];
            for (i in data) {
                tempUrls.push("/posts/" + data[i].url + ".md");
            }
            return tempUrls;
        })
        .then(arrUrls => {
            for (i = 0; i < arrUrls.length; i++) {
                console.log(i)
                let p = i;
                fetch(arrUrls[i])
                    .then((response) => response.text())
                    .then((data) => {
                        const { metadata, text } = metadataParser(data);
                        const pureText = marked.parse(text).replace(/<[^>]*>/g, '');
                        document.getElementsByClassName("summary")[p].querySelector("a").textContent = pureText.substring(0, 80).concat(' ...');
                        document.getElementsByClassName("count")[p].textContent = pureText.length + "字"
                    });
            }
        })

    // 定义一个元数据解析器
    function metadataParser(text) {
        // 用正则表达式匹配元数据
        const regex = /^---\n([\s\S]*?)\n---\n/;
        const match = regex.exec(text);
        // 如果有元数据，返回一个对象，包含元数据和剩余的文本
        if (match) {
            const metadata = {};
            const lines = match[1].split('\n');
            for (const line of lines) {
                const [key, value] = line.split(':');
                metadata[key.trim()] = value.trim();
            }
            return {
                metadata: metadata,
                text: text.slice(match[0].length),
            };
        }
        // 如果没有元数据，返回原始文本
        return {
            text: text,
        };
    };

</script>
<script>
    //navbar
    document.querySelector("#navMenu").addEventListener("click", () => {
        document.getElementsByClassName('navLinkGroup')[0].classList.toggle("active");
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</html>